---
# This assumes you can already reach the host (e.g., HTTP 5985).
# In practice, prefer Azure RunCommand or VM Extension to run enable-winrm-https.ps1.

- name: Ensure PSRemoting is enabled
  ansible.windows.win_shell: |
    Enable-PSRemoting -SkipNetworkProfileCheck -Force

- name: Create self-signed cert for WinRM if not present
  ansible.windows.win_shell: |
    if (-not (Get-ChildItem Cert:\LocalMachine\My | Where-Object { $_.Subject -like "CN=WinRM*" })) {
      New-SelfSignedCertificate -DnsName "{{ inventory_hostname }}" -CertStoreLocation "Cert:\LocalMachine\My" -FriendlyName "WinRM Self-Signed"
    }

- name: Configure WinRM HTTPS listener
  ansible.windows.win_shell: |
    $cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object { $_.FriendlyName -eq "WinRM Self-Signed" } | Select-Object -First 1
    winrm delete winrm/config/Listener?Address=*+Transport=HTTPS 2>$null
    winrm create winrm/config/Listener?Address=*+Transport=HTTPS "@{Hostname='{{ inventory_hostname }}';CertificateThumbprint='$($cert.Thumbprint)'}"

- name: Configure WinRM service and auth
  ansible.windows.win_shell: |
    winrm set winrm/config/service/auth '@{Basic="true"}'
    winrm set winrm/config/service '@{AllowUnencrypted="false"}'

- name: Open firewall for WinRM HTTPS
  ansible.windows.win_firewall_rule:
    name: "WinRM HTTPS"
    localport: 5986
    action: allow
    direction: in
    protocol: TCP
    state: present
    enabled: yes